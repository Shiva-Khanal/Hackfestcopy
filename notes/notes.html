<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Study Quest â€” Notes</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* =========================
       Basic reset & accessibility
       ========================= */
    *,*::before,*::after { box-sizing: border-box; }
    html,body { height:100%; margin:0; padding:0; }
    /* Prevent any horizontal scroll caused by wide elements */
    body { overflow-x: hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    :root{
      --bg-grad: linear-gradient(
        135deg,
        #EEF2F7 0%,
        #EEF2F7 25%,
        #C7D3E9 25%,
        #C7D3E9 50%,
        #90A1D5 50%,
        #90A1D5 75%,
        #5D6BB3 75%,
        #5D6BB3 100%
      );

      --primary: #4b4aa1;
      --primary-strong: #3d3a86;
      --danger: #d64557;
      --muted: #475569;
      --text: #07142a;
      --panel-bg: #ffffff;
      --card-bg: #ffffff;
      --input-bg: #ffffff;
      --soft-border: rgba(7,20,42,0.08);
      --focus: rgba(75,74,161,0.18);
      --max-page-width: 1200px;
      --gutter: 20px;
    }

    body {
      font-family: Inter, "Quicksand", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg-grad);
      font-size:16px;
      line-height:1.45;
    }

    /* Topbar */
    .topbar{
      background: rgba(255,255,255,0.98);
      display:flex;
      gap:20px;
      align-items:center;
      justify-content:space-between;
      padding:12px 28px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.06);
      position:sticky;
      top:0;
      z-index:40;
    }
    .logo { display:flex; gap:12px; align-items:center; flex-shrink:0; }
    .logo img{ height:42px; width:42px; border-radius:10px; object-fit:cover; display:block; }
    .nav { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .nav a { color:var(--text); text-decoration:none; font-weight:600; padding:6px 8px; border-radius:6px; display:inline-block; }
    .nav a.active { color:var(--primary); background: rgba(75,74,161,0.06); }

    /* Page container */
    .page {
      max-width: var(--max-page-width);
      margin: 22px auto;
      padding: 0 var(--gutter);
      width: calc(100% - (var(--gutter) * 2));
    }

    /* Layout: left rail + main */
    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 24px;
      align-items: start;
      width:100%;
    }
    @media (max-width: 920px) {
      .layout { grid-template-columns: 1fr; }
    }

    /* Left rail */
    .leftrail {
      background: var(--panel-bg);
      border-radius:12px;
      padding:14px;
      box-shadow: 0 8px 20px rgba(2,6,23,0.06);
      border: 1px solid var(--soft-border);
      overflow: visible; /* no forced scroll */
    }
    .leftrail h4 { margin:0 0 10px 0; font-weight:700; font-size:14px }
    .folder-item {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; border-radius:8px; cursor:pointer;
      transition:all .12s; border:1px solid transparent; background:transparent;
      word-break:break-word;
    }
    .folder-item:hover { background:#f6f9ff; transform: translateY(-1px); border-color: var(--soft-border); }
    .folder-item.active { background: rgba(75,74,161,0.06); color:var(--primary); box-shadow: 0 6px 12px rgba(75,74,161,0.04); border-color: rgba(75,74,161,0.08); }

    .create-folder { display:flex; gap:8px; margin-top:12px; }
    .create-folder input {
      flex:1; padding:10px; border-radius:8px; border:1px solid var(--soft-border); background:var(--input-bg); min-width:0;
    }
    .create-folder button {
      background:var(--primary); color:white; padding:10px 12px; border-radius:8px; border:none; font-weight:600; cursor:pointer;
    }

    /* Main panel */
    .main { min-height:60vh; }
    .panel {
      background: var(--panel-bg);
      border-radius:12px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.04);
      border:1px solid var(--soft-border);
    }

    /* Upload area */
    .upload-card { display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap; }
    .dropzone {
      flex:1 1 420px;
      min-width: 220px;
      background: #f7f9ff;
      border-radius:10px; padding:18px;
      border:2px dashed rgba(7,20,42,0.04);
      display:flex; flex-direction:column; gap:8px; justify-content:center; align-items:center; text-align:center;
      transition: all .18s; color:var(--text);
      background-position: center;
      background-repeat: no-repeat;
      background-size: cover;
    }
    .dropzone.drag { background: #eef3ff; border-color: rgba(75,74,161,0.18); transform: translateY(-3px); }
    .dropzone p { margin:0; color:var(--muted); font-size:14px; }

    /* Meta column: responsive & shrink-safe */
    .meta {
      flex: 0 1 320px; /* can shrink on smaller screens */
      min-width: 200px;
      max-width: 100%;
      display:flex; flex-direction:column; gap:10px;
    }
    .meta label { font-size:13px; color:var(--muted); font-weight:600; }
    .meta input[type="text"], .meta .folder-input {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--soft-border); background:var(--input-bg); color:var(--text);
      font-size:15px;
    }
    .primary-btn {
      display:inline-flex; gap:8px; align-items:center;
      background: linear-gradient(180deg,var(--primary),var(--primary-strong));
      color:white; padding:12px 16px; border-radius:10px; font-weight:700; border:none; cursor:pointer;
      box-shadow: 0 10px 24px rgba(75,74,161,0.06); font-size:15px;
    }
    .primary-btn:hover { transform: translateY(-3px); }

    .btn-ghost { background:transparent; border:1px solid rgba(75,74,161,0.08); padding:8px 10px; border-radius:8px; color:var(--primary); font-weight:600; cursor:pointer; }
    .btn-ghost:hover { background: rgba(75,74,161,0.06); }

    /* suggestions dropdown */
    .suggestions { position:relative; }
    .suggest-list {
      position:absolute; left:0; right:0; top:44px; background:#fff; color:var(--text); border-radius:8px; overflow:auto;
      box-shadow: 0 8px 24px rgba(2,6,23,0.06); z-index:60; max-height:220px; border:1px solid var(--soft-border);
    }
    .suggest-list div { padding:8px 12px; cursor:pointer; font-size:15px; }
    .suggest-list div:hover { background:#f3f6ff; }

    /* controls */
    .search-input { padding:10px 12px; border-radius:10px; border:1px solid var(--soft-border); background:#fff; color:var(--text); min-width:220px; font-size:15px; }
    .sort-select { padding:8px 10px; border-radius:8px; border:1px solid var(--soft-border); background:#fff; color:var(--text); font-size:15px; }

    /* file grid */
    .file-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:14px; margin-top:18px; width:100%; }
    .file-card {
      background: var(--card-bg); padding:12px; border-radius:10px; min-height:120px; display:flex; flex-direction:column; justify-content:space-between;
      transition: transform .14s, box-shadow .14s; color:var(--text); border:1px solid var(--soft-border);
      word-break:break-word;
    }
    .file-card:hover { transform: translateY(-6px); box-shadow:0 12px 30px rgba(2,6,23,0.06); }
    .file-title { font-weight:700; font-size:15px; margin-bottom:6px; color:var(--text); }
    .file-meta { font-size:13px; color:#475569; margin-bottom:8px; }
    .file-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(2,6,23,0.35); display:flex; align-items:center; justify-content:center; z-index:80; }
    .modal { width: min(920px,95%); background:#fff; color:var(--text); border-radius:10px; overflow:hidden; box-shadow:0 20px 60px rgba(2,6,23,0.08); }
    .modal .body { padding:16px; max-height:80vh; overflow:auto; }

    /* focus */
    :focus { outline: 3px solid var(--focus); outline-offset:3px; border-radius:8px; }

    .no-files { color:#475569; }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <header class="topbar" role="banner">
    <div class="logo" aria-hidden="false">
      <img src="images/logo.png" alt="Study Quest logo" onerror="this.style.display='none'">
      <div>
        <div style="font-weight:700; font-family:Quicksand; color:var(--text)">Study Quest</div>
        <div style="font-size:12px; color:var(--muted)">Learn. Review. Level up.</div>
      </div>
    </div>

    <nav class="nav" role="navigation" aria-label="main">
      <a href="../index.html">Home</a>
      <a href="/inbuilt/inbuilt.html">Inbuilt</a>
      <a href="/self_test/selftest.html">Self Test</a>
      <a href="notes.html" class="active">Notes</a>
      <a href="/review/review.html">Review</a>
      <a href="/contact/contact.html">Contact</a>
    </nav>

    <div>
      <button class="primary-btn" aria-label="Create new note" id="quickNewBtn">+ New Note</button>
    </div>
  </header>

  <!-- PAGE -->
  <div class="page" role="main">
    <div class="layout">
      <!-- LEFT COLUMN -->
      <aside class="leftrail" aria-label="Folders">
        <h4>Folders</h4>
        <div id="folderListArea" style="display:flex;flex-direction:column;gap:8px"></div>

        <div style="margin-top:12px">
          <label for="newFolderInput" style="display:block; font-size:13px; color:var(--muted); margin-bottom:6px">Create folder</label>
          <div class="create-folder">
            <input id="newFolderInput" aria-label="New folder name" placeholder="e.g. Maths" />
            <button id="createFolderBtn" aria-label="Create folder">Create</button>
          </div>
        </div>
      </aside>

      <!-- MAIN COLUMN -->
      <section class="main">
        <!-- UPLOAD PANEL -->
        <section class="panel" aria-labelledby="uploadTitle">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
            <h2 id="uploadTitle" style="margin:0; color:var(--text); font-weight:700">Upload notes & files</h2>

            <div style="display:flex;gap:10px; align-items:center">
              <input id="search" class="search-input" placeholder="Search files, tags, folders..." aria-label="Search files">
              <select id="sort" class="sort-select" aria-label="Sort files">
                <option value="date">Sort: Newest</option>
                <option value="name">Sort: Name</option>
              </select>
            </div>
          </div>

          <div class="upload-card" style="margin-top:14px">
            <!-- Dropzone -->
            <div id="dropzone" class="dropzone" tabindex="0" aria-label="File drop area">
              <p style="font-weight:700; font-size:16px; color:var(--muted)">Drag & drop files here</p>
              <p style="font-size:13px; color:var(--muted)">or click <button id="pickFileBtn" type="button" class="btn-ghost" aria-label="Select files">Browse</button> to choose</p>
              <p style="font-size:12px;color:#6b7280">Supported: PDF, PNG, JPG, TXT, DOCX (small files)</p>
              <input id="hiddenFileInput" type="file" style="display:none" aria-hidden="true" multiple />
            </div>

            <!-- Meta column -->
            <div class="meta">
              <label for="titleInput">Title</label>
              <input id="titleInput" type="text" placeholder="Short descriptive title" aria-label="Title" />

              <label for="tagsInput">Tags (comma separated)</label>
              <input id="tagsInput" type="text" placeholder="e.g. algebra, chapter1" aria-label="Tags" />

              <label for="folderInput">Folder</label>
              <div class="suggestions" style="position:relative">
                <input id="folderInput" class="folder-input" type="text" placeholder="Type or choose existing" aria-autocomplete="list" aria-controls="folderSuggestions" aria-label="Folder name" />
                <div id="folderSuggestions" class="suggest-list" style="display:none" role="listbox" tabindex="-1"></div>
              </div>

              <div style="display:flex; gap:10px; margin-top:6px">
                <button id="uploadBtn" class="primary-btn" aria-label="Upload note">Upload file(s)</button>
                <button id="clearBtn" class="btn-ghost" aria-label="Clear form">Clear</button>
              </div>

              <div id="uploadProgressWrap" style="display:none; margin-top:8px">
                <div style="height:8px; background: rgba(7,20,42,0.04); border-radius:6px; overflow:hidden">
                  <div id="uploadProgress" style="width:0; height:100%; background:linear-gradient(90deg,var(--primary),#90A1D5)"></div>
                </div>
                <div style="font-size:12px; color:var(--muted); margin-top:6px">Uploadingâ€¦ <span id="uploadProgressLabel">0%</span></div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px; color:var(--muted); font-size:13px">
            Organize your study materials: group by folder, add tags, and search later.
          </div>
        </section>

        <!-- FILE GRID -->
        <section class="panel" style="margin-top:18px" aria-labelledby="filesTitle">
          <h3 id="filesTitle" style="margin:0 0 10px 0; color:var(--text); font-weight:700">Files</h3>
          <div id="noFilesMessage" class="no-files">No files yet â€” upload your first note.</div>
          <div id="filesGrid" class="file-grid" aria-live="polite" style="margin-top:10px"></div>
        </section>
      </section>
    </div>
  </div>

  <!-- modal placeholder -->
  <div id="modal" style="display:none" aria-hidden="true"></div>

  <script>
    /* ================
       Storage & utils
       ================ */
    const STORAGE_KEY = 'sq_notes_v1';
    function uid(){ return 'n_' + Math.random().toString(36).slice(2,10); }
    function nowISO(){ return new Date().toISOString(); }
    function getStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(e){ return {}; } }
    function setStore(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
    function ensureFolder(store,name){ if(!store[name]) store[name]=[]; }

    /* ================
       UI refs
       ================ */
    const folderListArea = document.getElementById('folderListArea');
    const newFolderInput = document.getElementById('newFolderInput');
    const createFolderBtn = document.getElementById('createFolderBtn');

    const dropzone = document.getElementById('dropzone');
    const hiddenFileInput = document.getElementById('hiddenFileInput');
    const pickFileBtn = document.getElementById('pickFileBtn');

    const titleInput = document.getElementById('titleInput');
    const tagsInput = document.getElementById('tagsInput');
    const folderInput = document.getElementById('folderInput');
    const folderSuggestions = document.getElementById('folderSuggestions');

    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const uploadProgressWrap = document.getElementById('uploadProgressWrap');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadProgressLabel = document.getElementById('uploadProgressLabel');

    const filesGrid = document.getElementById('filesGrid');
    const noFilesMessage = document.getElementById('noFilesMessage');

    const search = document.getElementById('search');
    const sort = document.getElementById('sort');

    let dragCounter = 0;
    let currentActiveFolder = null;

    /* ================
       Folder rail & suggestions
       ================ */
    function renderFolderRail(activeFolder){
      const store = getStore();
      folderListArea.innerHTML = '';
      const folders = Object.keys(store).sort((a,b)=> a.localeCompare(b));
      if(folders.length === 0){
        const p = document.createElement('div'); p.style.color = '#475569'; p.textContent = 'No folders yet';
        folderListArea.appendChild(p); return;
      }
      folders.forEach(folder=>{
        const el = document.createElement('div');
        el.className = 'folder-item' + (folder===activeFolder ? ' active' : '');
        el.setAttribute('role','button'); el.tabIndex = 0;
        el.innerHTML = `<span>${folder}</span><span style="font-size:13px;color:#475569">${store[folder].length}</span>`;
        el.onclick = ()=> { renderFiles(folder); setActiveFolder(folder); };
        el.onkeydown = (e)=> { if(e.key==='Enter') el.onclick(); };
        folderListArea.appendChild(el);
      });
      // auto-select first folder if none active
      if(!activeFolder && folders.length>0 && !currentActiveFolder){
        setActiveFolder(folders[0]);
      }
    }

    function populateFolderSuggestions(filter=''){
      const store = getStore();
      const folders = Object.keys(store).sort();
      folderSuggestions.innerHTML = '';
      const q = filter.trim().toLowerCase();
      const matches = folders.filter(f => f.toLowerCase().includes(q));
      if(matches.length === 0){ folderSuggestions.style.display='none'; return; }
      matches.forEach(f=>{
        const d = document.createElement('div');
        const i = f.toLowerCase().indexOf(q);
        if(q && i >= 0){
          const before = f.slice(0,i);
          const match = f.slice(i, i+q.length);
          const after = f.slice(i+q.length);
          d.innerHTML = `${escapeHtml(before)}<strong style="color:var(--primary)">${escapeHtml(match)}</strong>${escapeHtml(after)}`;
        } else d.textContent = f;
        d.onclick = ()=> { folderInput.value = f; folderSuggestions.style.display='none'; folderInput.focus(); };
        folderSuggestions.appendChild(d);
      });
      folderSuggestions.style.display='block';
    }

    folderInput.addEventListener('input', (e)=> populateFolderSuggestions(e.target.value));
    folderInput.addEventListener('focus', ()=> populateFolderSuggestions(folderInput.value));
    folderInput.addEventListener('blur', ()=> setTimeout(()=> folderSuggestions.style.display='none', 180));

    createFolderBtn.addEventListener('click', ()=>{
      const name = newFolderInput.value.trim();
      if(!name) return newFolderInput.focus();
      const store = getStore();
      if(store[name]){ alert('Folder already exists'); newFolderInput.value=''; return; }
      store[name]=[]; setStore(store); newFolderInput.value=''; renderFolderRail(name); renderFiles(name);
    });

    /* ================
       Drag & drop + file pick (works on Firefox)
       ================ */
    // Clicking dropzone opens file picker (reliable user gesture)
    dropzone.addEventListener('click', ()=> hiddenFileInput.click());
    pickFileBtn.addEventListener('click', ()=> hiddenFileInput.click());

    dropzone.addEventListener('dragenter', e=>{ e.preventDefault(); dragCounter++; dropzone.classList.add('drag'); });
    dropzone.addEventListener('dragover', e=> e.preventDefault());
    dropzone.addEventListener('dragleave', e=>{ dragCounter--; if(dragCounter<=0){ dropzone.classList.remove('drag'); dragCounter=0; }});
    dropzone.addEventListener('drop', e=>{ e.preventDefault(); dropzone.classList.remove('drag'); dragCounter=0; const files = e.dataTransfer && e.dataTransfer.files; if(files && files.length) handleFiles(files); });

    hiddenFileInput.addEventListener('change', e=> { const files = e.target.files; if(files && files.length) handleFiles(files); });

    clearBtn.addEventListener('click', clearForm);
    function clearForm(){
      titleInput.value=''; tagsInput.value=''; folderInput.value=''; hiddenFileInput.value=''; uploadProgressWrap.style.display='none';
      uploadProgress.style.width='0%'; uploadProgressLabel.textContent='0%'; dropzone.style.backgroundImage='none';
    }

    /* ================
       Upload logic (multi-file, duplicate handling)
       ================ */
    async function handleFiles(fileList){
      const files = Array.from(fileList);
      if(files.length === 0) return;
      // choose folder or default
      const folderName = (folderInput.value.trim() || 'Default').trim();
      uploadProgressWrap.style.display='block';
      let totalBytes = files.reduce((s,f)=> s + (f.size || 0), 0) || files.length;
      let processedBytes = 0;

      for(let i=0;i<files.length;i++){
        const file = files[i];
        // if single file AND title empty -> prefill title
        if(files.length === 1 && !titleInput.value.trim()){
          titleInput.value = file.name.replace(/\.[^/.]+$/, "");
        }
        // show image preview background for image files (helpful but not required)
        if(file.type.startsWith('image/')){
          const r = await readFileAsDataURL(file);
          dropzone.style.backgroundImage = 'url(' + r + ')';
          dropzone.style.backgroundSize = 'cover';
          dropzone.style.backgroundPosition = 'center';
        }

        // simulate progress while reading
        const dataUrl = await readFileAsDataURLWithProgress(file, (p) => {
          const partial = (processedBytes + p * (file.size || 1)) / (totalBytes || 1);
          const pct = Math.round(Math.min(99, partial * 100));
          uploadProgress.style.width = pct + '%';
          uploadProgressLabel.textContent = pct + '%';
        });

        const store = getStore();
        ensureFolder(store, folderName);
        const names = store[folderName].map(x=>x.name);
        let finalName = file.name;
        if(names.includes(finalName)){
          const dot = finalName.lastIndexOf('.');
          const base = dot>=0 ? finalName.slice(0,dot) : finalName;
          const ext = dot>=0 ? finalName.slice(dot) : '';
          let c=1;
          while(names.includes(`${base} (${c})${ext}`)) c++;
          finalName = `${base} (${c})${ext}`;
        }

        const note = {
          id: uid(),
          title: (files.length === 1 && titleInput.value.trim()) ? titleInput.value.trim() : file.name.replace(/\.[^/.]+$/,''),
          name: finalName,
          tags: tagsInput.value.split(',').map(s=>s.trim()).filter(Boolean),
          data: dataUrl,
          type: file.type,
          uploadedAt: nowISO()
        };
        store[folderName].unshift(note);
        setStore(store);

        processedBytes += file.size || 0;
        const overallPct = Math.round(Math.min(100, (processedBytes / (totalBytes || 1)) * 100));
        uploadProgress.style.width = overallPct + '%';
        uploadProgressLabel.textContent = overallPct + '%';
      }

      uploadProgress.style.width = '100%'; uploadProgressLabel.textContent = '100%';
      setTimeout(()=>{ uploadProgressWrap.style.display='none'; uploadProgress.style.width='0%'; uploadProgressLabel.textContent='0%'; }, 600);
      clearForm();
      renderFolderRail(folderName);
      renderFiles(folderName);
    }

    function readFileAsDataURL(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }
    // Simulated progress wrapper: FileReader rarely gives progressive progress reliably for dataURL, so we simulate for smooth UI
    function readFileAsDataURLWithProgress(file, onProgress){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result);
        reader.onerror = reject;
        let t = 0;
        const id = setInterval(()=>{ t += Math.random() * 0.12; if(t>1) t=1; onProgress && onProgress(t); if(t>=1) clearInterval(id); }, 60);
        reader.readAsDataURL(file);
      });
    }

    /* ================
       Render files grid
       ================ */
    function setActiveFolder(name){
      currentActiveFolder = name;
      const els = document.querySelectorAll('.folder-item');
      els.forEach(el => el.classList.toggle('active', el.textContent.trim().startsWith(name)));
      search.value = '';
    }

    function renderFiles(folderFilter = null){
      const store = getStore();
      filesGrid.innerHTML = '';
      const searchQ = (search.value || '').toLowerCase().trim();
      const sortBy = sort.value || 'date';
      let items = [];
      Object.keys(store).forEach(folder => (store[folder]||[]).forEach(note => items.push({folder,note})));
      if(folderFilter) items = items.filter(i => i.folder === folderFilter);
      if(currentActiveFolder && !folderFilter) items = items.filter(i => i.folder === currentActiveFolder);
      if(searchQ){
        items = items.filter(i => i.note.title.toLowerCase().includes(searchQ) || i.note.name.toLowerCase().includes(searchQ) || (i.note.tags||[]).some(t => t.toLowerCase().includes(searchQ)) || i.folder.toLowerCase().includes(searchQ));
      }
      items.sort((a,b) => sortBy==='name' ? a.note.title.localeCompare(b.note.title) : new Date(b.note.uploadedAt) - new Date(a.note.uploadedAt));
      if(items.length === 0){ noFilesMessage.style.display = 'block'; filesGrid.style.display = 'none'; return; } else { noFilesMessage.style.display='none'; filesGrid.style.display='grid'; }
      items.forEach(({folder,note})=>{
        const card = document.createElement('div'); card.className = 'file-card';
        card.innerHTML = `
          <div>
            <div class="file-title" title="${escapeHtml(note.title)}">${escapeHtml(note.title)}</div>
            <div class="file-meta">${escapeHtml(note.name)} â€¢ ${escapeHtml(folder)} â€¢ ${new Date(note.uploadedAt).toLocaleString()}</div>
            <div style="font-size:13px;color:#475569">${(note.tags||[]).slice(0,4).map(t=> '#' + escapeHtml(t)).join(' ')}</div>
          </div>
          <div class="file-actions" aria-hidden="true">
            <button class="btn-ghost" data-action="view">View</button>
            <button class="btn-ghost" data-action="download">Download</button>
            <button class="btn-ghost" data-action="edit">Edit</button>
            <button class="btn-ghost" data-action="delete" style="background: rgba(214,69,87,0.06); border-color: rgba(214,69,87,0.12)">Delete</button>
          </div>
        `;
        card.querySelector('[data-action="view"]').addEventListener('click', ()=> openViewer(note));
        card.querySelector('[data-action="download"]').addEventListener('click', ()=> downloadNote(note));
        card.querySelector('[data-action="edit"]').addEventListener('click', ()=> openEditor(folder,note));
        card.querySelector('[data-action="delete"]').addEventListener('click', ()=> confirmDelete(folder,note.id));
        filesGrid.appendChild(card);
      });
    }

    /* ================
       Viewer / Editor / Delete
       ================ */
    function openViewer(note){
      const modal = document.getElementById('modal');
      modal.innerHTML = `
        <div class="modal-backdrop" role="dialog" aria-modal="true">
          <div class="modal" role="document">
            <div style="padding:12px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eef4ff">
              <div style="font-weight:700">${escapeHtml(note.title)}</div>
              <div><button id="modalClose" class="btn-ghost">Close</button></div>
            </div>
            <div class="body" style="padding:18px; background:#fff;">
              ${note.type.startsWith('image/') ? `<img src="${note.data}" alt="${escapeHtml(note.title)}" style="max-width:100%;height:auto;border-radius:6px">`
                : note.type === 'application/pdf' ? `<iframe src="${note.data}" style="width:100%;height:70vh;border:none"></iframe>`
                : note.type.startsWith('text/') ? `<pre style="white-space:pre-wrap;background:#f7f9fc;padding:12px;border-radius:8px">${escapeHtml(atob(note.data.split(',')[1]||''))}</pre>`
                : `<div style="padding:8px;color:#334155">Preview not available. Use Download.</div>`
              }
            </div>
          </div>
        </div>
      `;
      modal.style.display='block';
      modal.querySelector('#modalClose').addEventListener('click', ()=> { modal.style.display='none'; modal.innerHTML=''; });
    }

    function downloadNote(note){
      const a = document.createElement('a'); a.href = note.data; a.download = note.name || note.title; document.body.appendChild(a); a.click(); a.remove();
    }

    function openEditor(folder,note){
      const modal = document.getElementById('modal');
      modal.innerHTML = `
        <div class="modal-backdrop" role="dialog" aria-modal="true">
          <div class="modal">
            <div style="padding:12px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eef4ff">
              <div style="font-weight:700">Edit file</div>
              <button id="editClose" class="btn-ghost">Close</button>
            </div>
            <div class="body">
              <label style="font-weight:600">Title</label>
              <input id="editTitle" style="width:100%;padding:10px;margin-bottom:10px" value="${escapeHtml(note.title)}">
              <label style="font-weight:600">Tags (comma separated)</label>
              <input id="editTags" style="width:100%;padding:10px;margin-bottom:10px" value="${escapeHtml((note.tags||[]).join(', '))}">
              <label style="font-weight:600">Move to folder</label>
              <input id="editFolder" style="width:100%;padding:10px;margin-bottom:14px" value="${escapeHtml(folder)}">
              <div style="display:flex;gap:10px;justify-content:flex-end">
                <button id="saveEdit" class="primary-btn">Save</button>
                <button id="cancelEdit" class="btn-ghost">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      `;
      modal.style.display='block';
      modal.querySelector('#editClose').addEventListener('click', ()=> { modal.style.display='none'; modal.innerHTML=''; });
      modal.querySelector('#cancelEdit').addEventListener('click', ()=> { modal.style.display='none'; modal.innerHTML=''; });
      modal.querySelector('#saveEdit').addEventListener('click', ()=>{
        const newTitle = modal.querySelector('#editTitle').value.trim() || note.title;
        const newTags = modal.querySelector('#editTags').value.split(',').map(s=>s.trim()).filter(Boolean);
        const newFolder = modal.querySelector('#editFolder').value.trim() || 'Default';
        const store = getStore();
        store[folder] = store[folder].filter(n => n.id !== note.id);
        if(store[folder].length === 0) delete store[folder];
        ensureFolder(store, newFolder);
        const names = store[newFolder].map(x=>x.name);
        let finalName = note.name;
        if(names.includes(finalName)){
          const dot = finalName.lastIndexOf('.');
          const base = dot>=0 ? finalName.slice(0,dot) : finalName;
          const ext = dot>=0 ? finalName.slice(dot) : '';
          let c=1; while(names.includes(`${base} (${c})${ext}`)) c++; finalName = `${base} (${c})${ext}`;
        }
        const updated = Object.assign({}, note, { title: newTitle, tags: newTags, name: finalName });
        store[newFolder].unshift(updated);
        setStore(store);
        modal.style.display='none'; modal.innerHTML='';
        renderFolderRail(newFolder);
        renderFiles(newFolder);
      });
    }

    function confirmDelete(folder,id){
      if(!confirm('Delete this file? This cannot be undone.')) return;
      const store = getStore(); store[folder] = store[folder].filter(n => n.id !== id); if(store[folder].length === 0) delete store[folder];
      setStore(store); renderFolderRail(); renderFiles();
    }

    /* ================
       helpers
       ================ */
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":"&#39;"}[c])); }

    /* ================
       search + sort
       ================ */
    search.addEventListener('input', ()=> renderFiles());
    sort.addEventListener('change', ()=> renderFiles());

    /* quick new note focus */
    document.getElementById('quickNewBtn').addEventListener('click', ()=> folderInput.focus());

    /* init */
    (function init(){
      renderFolderRail();
      renderFiles();
      // ensure the dropzone is keyboard accessible (Enter triggers file picker)
      dropzone.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); hiddenFileInput.click(); } });
    })();
  </script>
</body>
</html>
